#!/bin/zsh

########
# init #
########

__warn() {
  printf "$(tput setaf 136)! %s(tput sgr0)" "$@"
}

# helper function to source file safely
__safe_source() {
  [[ -s $1 ]] && source $1 || echo "Trying to load '$1' but it doesn't exist"
}

# fix colors when running tmux inside zsh
# export TERM=xterm-256color
# export TERM=xterm-256color-italic

export TERM=xterm-256color
[ -n "$TMUX" ] && export TERM=screen-256color
alias nvim="TERM=xterm-256color-italic nvim"

#########
# zplug #
#########

# Check if zplug is installed
export ZPLUG_HOME=~/.zplug
if [[ ! -d $ZPLUG_HOME ]]; then
  git clone https://github.com/zplug/zplug $ZPLUG_HOME
fi
source $ZPLUG_HOME/init.zsh && zplug update --self

# NOTE: $DOTFILES_DIRECTORY is defined in .zshenv
zplug "$DOTFILES_DIRECTORY/zsh/plugins/zsh-sensible", from:local

# TODO: fix permissions on this project bin folder
# workaround: save file in nvim with :w!
zplug "$DOTFILES_DIRECTORY/zsh/plugins/bookmark", \
  as:command, \
  hook-build:"chmod +x bin/*", \
  use:"bin/*", \
  from:local

zplug "zsh-users/zsh-syntax-highlighting", nice:10
zplug "zsh-users/zsh-completions"
zplug "djui/alias-tips"
zplug "b4b4r07/enhancd", use:enhancd.sh
zplug "junegunn/fzf", hook-build:"./install"

# zplug "plugins/dirhistory", from:"oh-my-zsh"
# zplug "plugins/git", from:"oh-my-zsh"
zplug "plugins/osx", from:"oh-my-zsh"

# prompt
# zplug "mafredri/zsh-async"
# zplug "sindresorhus/pure"

# Install plugins if there are plugins that have not been installed
if ! zplug check --verbose; then
    printf "Install? [y/N]: "
    if read -q; then
        echo; zplug install
    fi
fi

# Then, source plugins and add commands to $PATH
zplug load > /dev/null

#########################
# script initialization #
#########################

# fasd (https://github.com/clvv/fasd)
fasd_cache="${HOME}/.fasd-init-cache"
if [ "$(command -v fasd)" -nt "$fasd_cache" -o ! -s "$fasd_cache" ]; then
  fasd --init auto >| "$fasd_cache"
fi
source "$fasd_cache"
unset fasd_cache

# travis gem (https://github.com/travis-ci/travis.rb)
__safe_source ${HOME}/.travis/travis.sh

# fzf (https://github.com/junegunn/fzf)
#
# The following line is commented because fzf checks with the following line
# on install
# __safe_source ${HOME}/.fzf.zsh
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# n (https://github.com/tj/n)
export N_PREFIX="$HOME/n"
[[ :$PATH: == *":$N_PREFIX/bin:"* ]] || PATH+=":$N_PREFIX/bin"  # Added by n-install (see http://git.io/n-install-repo).

# $DOTFILES_DIRECTORY is exported on ~/.zshenv
# see install.sh
__safe_source ${DOTFILES_DIRECTORY}/zsh/exports.zsh
__safe_source ${DOTFILES_DIRECTORY}/zsh/functions.zsh
__safe_source ${DOTFILES_DIRECTORY}/zsh/aliases.sh

# Note: rvm must be sourced last or rvm will complain
__safe_source ${HOME}/.rvm/scripts/rvm

# remove functions from the global scope
unset -f __warn
unset -f __safe_source

